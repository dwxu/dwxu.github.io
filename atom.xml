<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Dongwu Xu</title>
  
  <subtitle>Blog</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.dwxu.me/"/>
  <updated>2018-05-20T15:26:09.348Z</updated>
  <id>http://www.dwxu.me/</id>
  
  <author>
    <name>Dongwu Xu</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Java泛型与类型擦除</title>
    <link href="http://www.dwxu.me/2018/05/19/java-generics/"/>
    <id>http://www.dwxu.me/2018/05/19/java-generics/</id>
    <published>2018-05-19T09:26:40.000Z</published>
    <updated>2018-05-20T15:26:09.348Z</updated>
    
    <content type="html"><![CDATA[<p>&emsp;&emsp;泛型是 JDK1.5 的一项新增特性，本质是参数化类型的应用，即所操作的数据类型被指定为一个参数，可以用在类、接口和方法的创建中，分别称为泛型类、泛型接口和泛型方法：</p><ul><li><p>泛型接口：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">通过类实现泛型接口时指定泛型 K 和 V 的具体类型，如 java.util 包中的 Map&lt;K, V&gt; ；</span><br></pre></td></tr></table></figure></li><li><p>泛型类：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">编译器无法知道 K 和 V 的具体类型，只有运行时才真正根据类型来构造和分配内存，如 java.util 包中的 HashMap&lt;K,V&gt; ；</span><br></pre></td></tr></table></figure></li><li><p>泛型方法：泛型方法返回值前加一个<k>、<v>等来声明这是一个泛型方法，如</v></k></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class HashMap&lt;K,V&gt; extends AbstractMap&lt;K,V&gt;</span><br><span class="line">    implements Map&lt;K,V&gt;, Cloneable, Serializable &#123;</span><br><span class="line">    ...</span><br><span class="line">    public V get(Object key) &#123;</span><br><span class="line">        Node&lt;K,V&gt; e;</span><br><span class="line">        return (e = getNode(hash(key), key)) == null ? null : e.value;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    public V put(K key, V value) &#123;</span><br><span class="line">        return putVal(hash(key), key, value, false, true);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&emsp;&emsp;实际上，Java中 的泛型与 C++/C# 的中泛型实现不同，只在程序源码中存在，在编译后的字节码文件中，就已经替换为原生类型（也称为裸类型，如 Map&lt;K, V&gt; 即为 Map），并且在相应的地方插入了强制类型转换的代码，如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">Map&lt;String, String&gt; data = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">data.put(<span class="string">"foo"</span>, <span class="string">"foo"</span>);</span><br><span class="line">data.put(<span class="string">"bar"</span>, <span class="string">"bar"</span>);</span><br><span class="line">data.put(<span class="string">"baz"</span>, <span class="string">"baz"</span>);</span><br><span class="line">System.out.println(data.get(<span class="string">"foo"</span>));</span><br><span class="line">System.out.println(data.get(<span class="string">"bar"</span>));</span><br><span class="line">System.out.println(data.get(<span class="string">"baz"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>  编译为 Class 文件后，反编译后：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] paramArrayOfString)</span> </span>&#123;</span><br><span class="line">    HashMap localHashMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">    localHashMap.put(<span class="string">"foo"</span>, <span class="string">"foo"</span>);</span><br><span class="line">    localHashMap.put(<span class="string">"bar"</span>, <span class="string">"bar"</span>);</span><br><span class="line">    localHashMap.put(<span class="string">"baz"</span>, <span class="string">"baz"</span>);</span><br><span class="line">    System.out.println((String)localHashMap.get(<span class="string">"foo"</span>));</span><br><span class="line">    System.out.println((String)localHashMap.get(<span class="string">"bar"</span>));</span><br><span class="line">    System.out.println((String)localHashMap.get(<span class="string">"baz"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>  这种类型擦除的方式实现的泛型支持，只是作为一种语法糖来方便程序员的代码开发，提高效率和语法的严谨性，减少编码出错的机会，但并没有提供底层实质性的功能改进，因此 Java 的泛型支持实现一直存在争议和批评，例如由于 List<string> 和 List<integer> 擦除后是同一类型（List），无法实现重载（实际上，两个方法如果返回值类型不同，使用 Sun JDK 1.6 的 javac 也能编译成功）。</integer></string></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&amp;emsp;&amp;emsp;泛型是 JDK1.5 的一项新增特性，本质是参数化类型的应用，即所操作的数据类型被指定为一个参数，可以用在类、接口和方法的创建中，分别称为泛型类、泛型接口和泛型方法：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;泛型接口：&lt;/p&gt;
&lt;figure class=&quot;
      
    
    </summary>
    
      <category term="Java" scheme="http://www.dwxu.me/categories/Java/"/>
    
    
      <category term="泛型" scheme="http://www.dwxu.me/tags/%E6%B3%9B%E5%9E%8B/"/>
    
      <category term="语法糖" scheme="http://www.dwxu.me/tags/%E8%AF%AD%E6%B3%95%E7%B3%96/"/>
    
  </entry>
  
  <entry>
    <title>高并发下多站点在线访问实时统计</title>
    <link href="http://www.dwxu.me/2018/05/16/online-statistics/"/>
    <id>http://www.dwxu.me/2018/05/16/online-statistics/</id>
    <published>2018-05-16T15:20:09.000Z</published>
    <updated>2018-05-16T15:24:15.382Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、业务背景"><a href="#一、业务背景" class="headerlink" title="一、业务背景"></a>一、业务背景</h3><ul><li>实时统计多个站点的在线独立访问情况；</li><li>统计的时间范围为 10/15/30 分钟；</li><li>所有站点每秒累计约 10w 的 pv；</li></ul><h3 id="二、解决思路"><a href="#二、解决思路" class="headerlink" title="二、解决思路"></a>二、解决思路</h3><ul><li>按客户端 IP+SessionId 区分独立访问；</li><li>将在线访问信息（站点ID、IP、Session Id、访问时间等）写入 Kafka 集群；</li><li>Storm(集群) 实时消费 Kafka 在线访问信息/消息，合并访问写入 Redis；</li><li>上层应用从 Redis 获取各站点 10/15/30 分钟内的独立访问数据进行计算并展示；</li></ul><h3 id="三、详细设计"><a href="#三、详细设计" class="headerlink" title="三、详细设计"></a>三、详细设计</h3><h4 id="1-redis-数据结构设计"><a href="#1-redis-数据结构设计" class="headerlink" title="1. redis 数据结构设计"></a>1. redis 数据结构设计</h4><ul><li>将每分钟的站点数据写入一个 Hash 集合（过期时间为 30 分钟），key 为 online:{comId}:{minute}，其中 {comId} 为站点ID，{minute} 为在线时间的分钟字段（0-59）；</li><li>集合下的元素结构为：field - {ip}:{sessionId}（独立访问），value - 该独立访问一分钟内的请求/响应次数，通过 hincrby 指令递增；</li></ul><h4 id="2-数据统计"><a href="#2-数据统计" class="headerlink" title="2. 数据统计"></a>2. 数据统计</h4><ul><li>统计范围为当前 10/15/30 分钟内；</li><li>通过站点ID及当前时间从 redis 中读取该站点 30 分钟内的数据集合，例如站点ID为1，查询时间为 9点33分钟，则从 redis 读取 online:1:33 - online:1:3 的数据集合；</li><li>合并数据集合的 key（{ip}:{sessionId}），即去重，即可得到指定时间范围内的在线访问数；</li></ul><h4 id="3-说明"><a href="#3-说明" class="headerlink" title="3. 说明"></a>3. 说明</h4><ul><li>数据写入 Redis 频繁，需要优先考虑写入耗时和内存的问题，因此通过 hincrby 和 expired 这两个时间复杂度为 O(1) 的指令来快速写入在线数据；</li><li>每个站点的数据集合过期时间为 30 分钟（根据请求时间计算过期的时间戳），因此一个站点最多同时存在 30 个数据集合，过期的集合由 Redis 自动清理，无需再自行清理；</li><li>每个集合的有效数据实际为 field 的部分，记录每分钟的独立访问，接口在获取数据进行统计时，直接取出 field 的 Set 集合进行自动合并即可；</li></ul><h3 id="四、线上情况"><a href="#四、线上情况" class="headerlink" title="四、线上情况"></a>四、线上情况</h3><ul><li>Redis 单机/单实例；</li><li>30分钟内活跃的站点约 1.5w 个，两个小时内监控 Redis，redis 总内存占用稳定在 5.5G 以下（较上线此统计前多占用 1G 内存），数据集合能够正常过期并被 redis 清理；</li><li>应用 0.3s 内完成统计访问最频繁/数据量最大的站点的各时段内在线访问情况，当然跟服务器性能比较好也有关系；</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;一、业务背景&quot;&gt;&lt;a href=&quot;#一、业务背景&quot; class=&quot;headerlink&quot; title=&quot;一、业务背景&quot;&gt;&lt;/a&gt;一、业务背景&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;实时统计多个站点的在线独立访问情况；&lt;/li&gt;
&lt;li&gt;统计的时间范围为 10/15/30 分钟
      
    
    </summary>
    
      <category term="解决方案" scheme="http://www.dwxu.me/categories/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    
    
      <category term="实时统计" scheme="http://www.dwxu.me/tags/%E5%AE%9E%E6%97%B6%E7%BB%9F%E8%AE%A1/"/>
    
      <category term="Redis" scheme="http://www.dwxu.me/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>各大搜索引擎来路referer头部及搜索关键字字段</title>
    <link href="http://www.dwxu.me/2018/05/15/search-engine-referer/"/>
    <id>http://www.dwxu.me/2018/05/15/search-engine-referer/</id>
    <published>2018-05-15T12:25:00.000Z</published>
    <updated>2018-05-15T12:38:28.993Z</updated>
    
    <content type="html"><![CDATA[<h4 id="1-百度搜索："><a href="#1-百度搜索：" class="headerlink" title="1. 百度搜索："></a>1. 百度搜索：</h4><ul><li><p>PC端：</p><ul><li><p>referer：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.baidu.com/link?url=gZRk-i0rKd2zEpXr6gLWgcMaB6gj49Qh0SRhVyeD1TG&amp;wd=&amp;eqid=e0224cf50000f590000000065ac98dee</span><br></pre></td></tr></table></figure></li><li><p>关键字字段：wd（无实际值）</p></li></ul></li><li><p>移动端：</p><ul><li><p>referer：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://m.baidu.com/from=0/bd_page_type=1/ssid=0/uid=0/pu=usm%401%2Csz%40320_1001%2Cta%40iphone_2_6.0_3_537/baiduid=EDC0F469B2C8C28ED6153A8DFE7B0F35/w=0_10_/t=iphone/l=1/tc?ref=www_iphone&amp;lid=9293408228010889187&amp;order=1&amp;fm=alop&amp;dict=-1&amp;tj=www_sitelink_normal_1_0_10_title&amp;wd=&amp;eqid=80f8d18b77481000100000005ac98e54&amp;w_qd=IlPT2AEptyoA_yjkTUugn4fHR5kW&amp;tcplug=1&amp;sec=28899&amp;di=6b8e30a65323dcbb&amp;bdenc=1&amp;tch=124.0.206.178.0.0&amp;nsrc=IlPT2AEptyoA_yixCFOxXnANedT62v3IEQGG_8kJLDKv7JuV&amp;clk_info=%7B%22srcid%22%3A1539%2C%22tplname%22%3A%22www_sitelink_normal%22%2C%22t%22%3A1523158616510%2C%22xpath%22%3A%22div-a-h3-em%22%7D</span><br></pre></td></tr></table></figure></li><li><p>关键字字段：wd（无实际值）</p></li></ul></li></ul><h4 id="2-搜狗搜索（soso-搜索）："><a href="#2-搜狗搜索（soso-搜索）：" class="headerlink" title="2. 搜狗搜索（soso 搜索）："></a>2. 搜狗搜索（soso 搜索）：</h4><ul><li><p>PC端：</p><ul><li><p>referer：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.sogou.com/link?url=DSOYnZeCC_oowgX7OeX6FW4YafSeot-j</span><br></pre></td></tr></table></figure></li><li><p>关键字字段：无</p></li></ul></li><li><p>移动端：</p><ul><li><p>referer：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://m.sogou.com/web/searchList.jsp?uID=vU0WMAQthy-ORLar&amp;v=5&amp;from=index&amp;w=1274&amp;t=1523158841365&amp;s_t=1523158844479&amp;s_from=index&amp;keyword=51la%E7%BB%9F%E8%AE%A1&amp;pg=webSearchList&amp;sourceid=sugg&amp;sugoq=&amp;sugn=0&amp;suguuid=fa153a85-07bb-4afa-bb07-69d3775d9966&amp;sugsuv=AAHV9fA6HwAAAAqRK1G8bQ0A1wA%3D&amp;sugtime=1523158844484</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://wap.sogou.com/web/searchList.jsp?uID=vU0WMAQthy-ORLar&amp;v=5&amp;from=index&amp;w=1274&amp;t=1523158841365&amp;s_t=1523158844479&amp;s_from=index&amp;keyword=51la%E7%BB%9F%E8%AE%A1&amp;pg=webSearchList&amp;sourceid=sugg&amp;sugoq=&amp;sugn=0&amp;suguuid=fa153a85-07bb-4afa-bb07-69d3775d9966&amp;sugsuv=AAHV9fA6HwAAAAqRK1G8bQ0A1wA%3D&amp;sugtime=1523158844484</span><br></pre></td></tr></table></figure></li><li><p>关键字字段：keyword（有实际值）</p></li></ul></li></ul><h4 id="3-360-搜索（360好搜）："><a href="#3-360-搜索（360好搜）：" class="headerlink" title="3. 360 搜索（360好搜）："></a>3. 360 搜索（360好搜）：</h4><ul><li><p>PC端：</p><ul><li><p>referer：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.so.com/link?m=afEPOwxb%2BqdAts7rzNmmh%2F2cxMIM5669zqvLn1I5nPYjRlp8haa0nn%2FWJfYFNGvfzb4XdzUBb5wCnL2um08mnoi%2Bsge9ZjqTN</span><br></pre></td></tr></table></figure></li><li><p>referer 关键字字段：无</p></li></ul></li><li><p>移动端：</p><ul><li><p>referer：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://m.so.com/s?q=51la%E7%BB%9F%E8%AE%A1&amp;src=msearch_next_input&amp;sug_pos=&amp;sug=&amp;srcg=home_next</span><br></pre></td></tr></table></figure></li><li><p>关键字字段：q（有实际值）</p></li></ul></li></ul><h4 id="4-谷歌搜索："><a href="#4-谷歌搜索：" class="headerlink" title="4. 谷歌搜索："></a>4. 谷歌搜索：</h4><ul><li><p>PC端：</p><ul><li><p>referer：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.google.co.jp/（每个国家/地区的域名后缀不同，如 co.jp - 日本，hk - 香港，de - 德国）</span><br></pre></td></tr></table></figure></li><li><p>referer 关键字字段：无</p></li></ul></li><li><p>移动端：</p><ul><li><p>referer：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.google.com/</span><br></pre></td></tr></table></figure></li><li><p>关键字字段：无</p></li></ul></li></ul><h4 id="5-神马搜索："><a href="#5-神马搜索：" class="headerlink" title="5. 神马搜索："></a>5. 神马搜索：</h4><ul><li>PC端：无</li><li><p>移动端：</p><ul><li><p>referer：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://zm12.sm-tc.cn/?src=l4uLj8XQ0IiIiNHKztGTntA%3D&amp;uid=b64442e88b6decc4f6ade0bf131e6af0&amp;hid=0828a13d4a51cd539610a6c5a2e50f36&amp;pos=1&amp;cid=9&amp;time=1523160482592&amp;from=click&amp;restype=1&amp;pagetype=0400000000000004&amp;bu=web&amp;query=51la%E7%BB%9F%E8%AE%A1&amp;mode=&amp;v=1&amp;province=%E5%B9%BF%E4%B8%9C%E7%9C%81&amp;city=%E5%B9%BF%E5%B7%9E%E5%B8%82&amp;uc_param_str=dnntnwvepffrgibijbprsvdsdichei</span><br></pre></td></tr></table></figure></li><li><p>关键字字段：query（有实际值），host 为 zm12.sm-tc.cn</p></li></ul></li></ul><h4 id="6-BingLive（微软Bing搜索）："><a href="#6-BingLive（微软Bing搜索）：" class="headerlink" title="6. BingLive（微软Bing搜索）："></a>6. BingLive（微软Bing搜索）：</h4><ul><li><p>PC端：</p><ul><li><p>referer：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.bing.com/</span><br></pre></td></tr></table></figure></li><li><p>关键字字段：无</p></li></ul></li><li><p>移动端：</p><ul><li><p>referer：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.bing.com/</span><br></pre></td></tr></table></figure></li><li><p>关键字字段：无</p></li></ul></li></ul><h4 id="7-有道-网易搜索：目前仅为词典搜索"><a href="#7-有道-网易搜索：目前仅为词典搜索" class="headerlink" title="7. 有道/网易搜索：目前仅为词典搜索"></a>7. 有道/网易搜索：目前仅为词典搜索</h4>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;1-百度搜索：&quot;&gt;&lt;a href=&quot;#1-百度搜索：&quot; class=&quot;headerlink&quot; title=&quot;1. 百度搜索：&quot;&gt;&lt;/a&gt;1. 百度搜索：&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;PC端：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;referer：&lt;/p&gt;
&lt;figu
      
    
    </summary>
    
      <category term="互联网" scheme="http://www.dwxu.me/categories/%E4%BA%92%E8%81%94%E7%BD%91/"/>
    
    
      <category term="搜索引擎" scheme="http://www.dwxu.me/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://www.dwxu.me/2018/05/14/Hello-World/"/>
    <id>http://www.dwxu.me/2018/05/14/Hello-World/</id>
    <published>2018-05-14T13:31:51.000Z</published>
    <updated>2018-05-14T15:32:08.106Z</updated>
    
    <content type="html"><![CDATA[<p>你好，世界！</p><p>不客观的说，自己也不算懒，但也不知道拖延了多久，总算是把个人博客的样子给整出来了。</p><p>基于 GitHub + Hexo 搭建，找了一套相对简洁的页面模板，稍微加以改造，便是现在这个样子，还算满意。</p><p>年后转到公司新的部门后，一直比较忙，期间也解决了一些大大小小的问题，在业务和技术方面也算有所收获，也一直想着找机会和时间总结并记录下来，于是乎又想起来久违的个人博客计划，花了两个晚上失落，过程比较顺利。</p><p>那么，之后要花更多的时间和精力，充实博客，充实自己！</p><p>晚安！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;你好，世界！&lt;/p&gt;
&lt;p&gt;不客观的说，自己也不算懒，但也不知道拖延了多久，总算是把个人博客的样子给整出来了。&lt;/p&gt;
&lt;p&gt;基于 GitHub + Hexo 搭建，找了一套相对简洁的页面模板，稍微加以改造，便是现在这个样子，还算满意。&lt;/p&gt;
&lt;p&gt;年后转到公司新的部门后
      
    
    </summary>
    
      <category term="日记" scheme="http://www.dwxu.me/categories/%E6%97%A5%E8%AE%B0/"/>
    
    
      <category term="日记" scheme="http://www.dwxu.me/tags/%E6%97%A5%E8%AE%B0/"/>
    
  </entry>
  
</feed>
